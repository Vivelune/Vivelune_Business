// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// UPDATED: User model for Clerk authentication
model User {
  id            String    @id @default(cuid())
  email         String
  firstName     String?
  lastName      String?
  name          String?   // Keep for backward compatibility
  imageUrl      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Clerk specific fields
  clerkId       String    @unique
  emailVerified Boolean   @default(false)
  
  // Stripe fields
  stripeCustomerId      String?  @unique  // Stripe customer ID
  stripeSubscriptionId  String?  @unique  // Current active subscription ID
  
  // Relations
  workflows     Workflow[]
  credentials   Credential[]
  subscriptions Subscription[]  // History of subscriptions
  invoices      Invoice[]       // User's invoices

  @@unique([email])
  @@map("user")
}

// NEW: Subscription model for Stripe
model Subscription {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Stripe subscription fields
  stripeSubscriptionId  String   @unique
  stripeCustomerId      String
  stripePriceId         String
  stripeProductId       String
  
  // Subscription status
  status        SubscriptionStatus @default(ACTIVE)
  
  // Plan details
  planType      PlanType  // e.g., PRO, ENTERPRISE
  interval      String?   // month, year
  
  // Dates
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean  @default(false)
  canceledAt         DateTime?
  trialStart         DateTime?
  trialEnd           DateTime?
  
  // Metadata
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  invoices      Invoice[]  // Invoices related to this subscription

  @@map("subscription")
}

// NEW: Invoice model for Stripe invoices
model Invoice {
  id              String    @id @default(cuid())
  stripeInvoiceId String    @unique
  stripeCustomerId String
  userId          String?
  user            User?     @relation(fields: [userId], references: [id])
  
  // Invoice details
  amount          Int       // in cents
  currency        String
  status          String    // paid, open, void, etc.
  
  // Dates
  created         DateTime
  paidAt          DateTime?
  
  // PDF URL
  invoicePdf      String?
  
  // Relations
  subscriptionId  String?
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id])

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("invoice")
}

// NEW: WebhookEvent model to track Stripe webhook events (idempotency)
model WebhookEvent {
  id              String    @id @default(cuid())
  stripeEventId   String    @unique
  type            String
  processed       Boolean   @default(false)
  processedAt     DateTime?
  error           String?
  
  createdAt       DateTime  @default(now())

  @@map("webhook_event")
}

// Enums
enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  PAUSED
}

enum PlanType {
  PRO
  ENTERPRISE
  // Add more plans as needed
}

// Keep existing models below - NO CHANGES NEEDED
model Credential{
  id String @id @default(cuid())
  name String
  value String
  type CredentialType
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  userId String
  user User @relation(fields: [userId], references:[id], onDelete: Cascade)

  Node Node[]
}

model Workflow{
  id         String   @id @default(cuid())
  name       String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  nodes Node[]
  connections Connection[]
  executions Execution[]

  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum NodeType{
  INITIAL
  MANUAL_TRIGGER
  HTTP_REQUEST
  GOOGLE_FORM_TRIGGER
  STRIPE_TRIGGER
  ANTHROPIC
  GEMINI
  OPENAI
  DEEPSEEK
  DISCORD
  SLACK
}

model Node{
    id String @id @default(cuid())
    workflowId String
    workflow Workflow @relation(fields: [workflowId], references:[id], onDelete: Cascade)

    name String
    type NodeType
    position Json
    data Json @default("{}")

    credentialId String?
    credential Credential? @relation(fields: [credentialId], references: [id])

    outputConnections Connection[] @relation("FromNode")
    inputConnections Connection[] @relation("ToNode")
    
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
}

enum CredentialType {
  OPENAI
  ANTHROPIC
  GEMINI
  DEEPSEEK
}

model Connection {
    id String @id @default(cuid())
    workflowId String
    workflow Workflow @relation(fields: [workflowId], references:[id], onDelete: Cascade)

    fromNodeId String
    fromNode Node @relation("FromNode", fields: [fromNodeId], references:[id], onDelete: Cascade )
    
    toNodeId String
    toNode Node @relation("ToNode", fields: [toNodeId], references:[id], onDelete: Cascade )

    fromOutput String @default("main")
    toInput String @default("main")

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt

    @@unique([fromNodeId, toNodeId,fromOutput, toInput ])
}

enum ExecutionStatus {
    RUNNING
    SUCCESS
    FAILED
}

model Execution {
    id String @id @default(cuid())

    workflowId String
    workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

    status ExecutionStatus @default(RUNNING)
    error String? @db.Text
    errorStack String? @db.Text

    startedAt DateTime @default(now())
    completedAt DateTime?

    inngestEventId String @unique

    output Json?
}

